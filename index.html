<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ—Ç—Ä–æ –§–æ—Ä—É–º 2007 Pro - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Verdana, Arial, sans-serif;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4"><rect fill="%23c0c0c0" width="4" height="4"/><rect fill="%23999" x="0" y="0" width="2" height="2"/></svg>');
            background-color: #b0b0b0;
            color: #333;
            line-height: 1.4;
            font-size: 12px;
            padding: 10px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(to bottom, #1f5b9c, #1a4d7a);
            border: 2px solid #333;
            padding: 15px;
            margin-bottom: 10px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .header p {
            font-size: 10px;
            color: #ddd;
            margin: 0;
        }

        .header-right {
            text-align: right;
            font-size: 11px;
        }

        .header-right p {
            margin: 2px 0;
            color: #ddd;
        }

        .header-right strong {
            color: #ffff00;
        }

        .nav-bar {
            background: linear-gradient(to bottom, #8b8b8b, #707070);
            border: 2px solid #333;
            padding: 8px 10px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #000;
            flex-wrap: wrap;
        }

        .nav-bar a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            padding: 4px 10px;
            background: linear-gradient(to bottom, #a0a0a0, #808080);
            border: 2px outset #dfdfdf;
            border-radius: 3px;
            font-size: 11px;
            transition: all 0.1s;
        }

        .nav-bar a:hover {
            background: linear-gradient(to bottom, #b0b0b0, #909090);
            border-style: inset;
        }

        .nav-bar a.active {
            background: linear-gradient(to bottom, #707070, #505050);
            border-style: inset;
            color: #ffff00;
        }

        .main-content {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-panel {
            background: #e8e8e8;
            border: 2px solid;
            border-color: #dfdfdf #808080 #808080 #dfdfdf;
            box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #000;
        }

        .panel-header {
            background: linear-gradient(to right, #000080, #1084d7);
            color: white;
            padding: 8px 10px;
            font-weight: bold;
            font-size: 11px;
        }

        .panel-body {
            padding: 10px;
            background: #f5f5f5;
            font-size: 11px;
        }

        .panel-body p {
            margin: 5px 0;
        }

        .panel-body a {
            display: block;
            color: #000080;
            text-decoration: underline;
            cursor: pointer;
            margin: 3px 0;
            padding: 2px;
        }

        .panel-body a:hover {
            background: #e0e0e0;
        }

        .forum-section {
            background: #e8e8e8;
            border: 2px solid;
            border-color: #dfdfdf #808080 #808080 #dfdfdf;
            box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #000;
        }

        .section-header {
            background: linear-gradient(to right, #000080, #1084d7);
            color: white;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-body {
            padding: 0;
        }

        .forum-item {
            display: grid;
            grid-template-columns: 50px 1fr 70px 70px;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: 1px solid #dfdfdf;
            align-items: center;
            background: white;
            transition: background 0.2s;
        }

        .forum-item:hover {
            background: #f0f0f0;
        }

        .forum-item:last-child {
            border-bottom: none;
        }

        .forum-icon {
            text-align: center;
            font-size: 20px;
        }

        .forum-info h3 {
            font-size: 12px;
            margin: 0 0 2px 0;
            color: #000080;
            text-decoration: underline;
            cursor: pointer;
        }

        .forum-info h3:hover {
            color: #1084d7;
        }

        .forum-info p {
            font-size: 10px;
            margin: 0;
            color: #666;
        }

        .forum-stats {
            text-align: center;
            font-size: 10px;
        }

        .thread-item {
            display: grid;
            grid-template-columns: 30px 1fr 50px 70px;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid #dfdfdf;
            align-items: center;
            background: white;
            transition: background 0.2s;
        }

        .thread-item:hover {
            background: #f0f0f0;
        }

        .thread-item:last-child {
            border-bottom: none;
        }

        .thread-icon {
            text-align: center;
            font-size: 16px;
        }

        .thread-info h4 {
            font-size: 11px;
            margin: 0 0 2px 0;
            color: #000080;
            cursor: pointer;
        }

        .thread-info h4:hover {
            color: #1084d7;
        }

        .thread-info p {
            font-size: 9px;
            margin: 0;
            color: #666;
        }

        .lock-badge {
            background: #ffcccc;
            color: #cc0000;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: bold;
            display: inline-block;
            margin-right: 4px;
        }

        .button {
            background: linear-gradient(to bottom, #c0c0c0, #a0a0a0);
            border: 2px outset #dfdfdf;
            color: #000;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            border-radius: 3px;
            transition: all 0.1s;
        }

        .button:hover {
            background: linear-gradient(to bottom, #d0d0d0, #b0b0b0);
        }

        .button:active {
            border-style: inset;
            background: linear-gradient(to bottom, #a0a0a0, #c0c0c0);
        }

        .button.primary {
            background: linear-gradient(to bottom, #1f5b9c, #1a4d7a);
            color: white;
            border-color: #fff;
        }

        .button.primary:hover {
            background: linear-gradient(to bottom, #2a6aad, #1f5b9c);
        }

        .button.danger {
            background: linear-gradient(to bottom, #cc0000, #990000);
            color: white;
        }

        .button.danger:hover {
            background: linear-gradient(to bottom, #dd0000, #aa0000);
        }

        .input-field {
            border: 2px inset #dfdfdf;
            padding: 4px 6px;
            font-family: Verdana, Arial, sans-serif;
            font-size: 11px;
            background: white;
            color: #000;
        }

        .textarea {
            border: 2px inset #dfdfdf;
            padding: 6px 8px;
            font-family: Verdana, Arial, sans-serif;
            font-size: 11px;
            background: white;
            color: #000;
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
        }

        .char-counter {
            font-size: 9px;
            color: #999;
            margin-top: 2px;
        }

        .post-item {
            background: #f0f0f0;
            border: 2px solid;
            border-color: #dfdfdf #808080 #808080 #dfdfdf;
            margin-bottom: 10px;
        }

        .post-header {
            background: linear-gradient(to right, #a0a0a0, #808080);
            color: white;
            padding: 6px 10px;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }

        .post-body {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: white;
        }

        .post-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1f5b9c, #1a4d7a);
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .post-content {
            flex: 1;
            font-size: 11px;
            line-height: 1.5;
        }

        .post-footer {
            background: #e8e8e8;
            padding: 6px 10px;
            font-size: 9px;
            color: #666;
            border-top: 1px solid #dfdfdf;
        }

        .post-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .post-action-link {
            cursor: pointer;
            color: #000080;
            text-decoration: underline;
        }

        .post-action-link:hover {
            color: #1084d7;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #c0c0c0;
            border: 3px solid;
            border-color: #dfdfdf #808080 #808080 #dfdfdf;
            box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #000;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(to right, #000080, #1084d7);
            color: white;
            padding: 4px 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 12px;
        }

        .modal-close {
            background: linear-gradient(to bottom, #c0c0c0, #a0a0a0);
            border: 2px outset #dfdfdf;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .modal-close:active {
            border-style: inset;
        }

        .modal-body {
            padding: 12px;
            background: #c0c0c0;
        }

        .no-data {
            padding: 20px;
            text-align: center;
            color: #666;
            background: white;
            font-size: 12px;
        }

        .message-item {
            background: white;
            border: 1px solid #dfdfdf;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 3px;
        }

        .message-item:hover {
            background: #f5f5f5;
        }

        .message-from {
            font-weight: bold;
            color: #000080;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .message-subject {
            font-weight: bold;
            font-size: 11px;
            color: #333;
            margin-bottom: 3px;
        }

        .message-text {
            font-size: 11px;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 9px;
            color: #999;
        }

        .message-unread {
            background: #ffffcc;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .action-bar {
            background: linear-gradient(to bottom, #8b8b8b, #707070);
            border: 2px solid #333;
            padding: 8px 10px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #000;
        }

        .user-status {
            padding: 10px;
            background: #f0f0f0;
            border: 1px solid #dfdfdf;
            border-radius: 3px;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .user-status strong {
            color: #000080;
        }

        .search-box {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .search-box input {
            flex: 1;
            border: 2px inset #dfdfdf;
            padding: 4px 6px;
            font-family: Verdana, Arial, sans-serif;
            font-size: 11px;
            background: white;
            color: #000;
        }

        .search-box button {
            padding: 4px 10px;
        }

        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00aa00;
            margin-right: 4px;
        }

        .user-item {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-item-actions {
            display: flex;
            gap: 8px;
        }

        .user-item-actions button {
            padding: 2px 8px;
            font-size: 10px;
        }

        .admin-user-row {
            display: grid;
            grid-template-columns: 100px 80px 70px 1fr 80px;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-size: 10px;
            align-items: center;
        }

        .admin-user-row:last-child {
            border-bottom: none;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tab-btn {
            padding: 4px 10px;
            font-size: 11px;
        }

        .tab-btn.active {
            background: linear-gradient(to bottom, #707070, #505050);
            border-style: inset;
            color: #ffff00;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-left, .header-right {
                flex: none;
            }

            .forum-item {
                grid-template-columns: 30px 1fr 50px;
            }

            .thread-item {
                grid-template-columns: 30px 1fr 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üñ•Ô∏è –†–µ—Ç—Ä–æ –§–æ—Ä—É–º 2007 Pro</h1>
                <p>–° —Å–∏—Å—Ç–µ–º–æ–π –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</p>
            </div>
            <div class="header-right" id="header-status">
                <p>–í—ã –Ω–µ –≤–æ—à–ª–∏</p>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-bar">
            <a class="nav-item active" onclick="showView('forums')">üìÇ –§–æ—Ä—É–º—ã</a>
            <a class="nav-item" onclick="showView('messages')">‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏—è <span id="message-badge" style="background:#ff0000;color:white;padding:1px 4px;border-radius:2px;font-size:9px;"></span></a>
            <a class="nav-item" onclick="showView('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a class="nav-item" onclick="showView('admin')" id="admin-btn" style="display:none;">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</a>
            <a class="nav-item" onclick="showLoginModal()">üîì –í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            <a class="nav-item" onclick="logout()" id="logout-btn" style="display:none;">üö™ –í—ã—Ö–æ–¥</a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-panel">
                    <div class="panel-header">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    <div class="panel-body">
                        <p><strong>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong> <span id="total-users">0</span></p>
                        <p><strong>–û–Ω–ª–∞–π–Ω:</strong> <span id="online-users">0</span></p>
                        <p><strong>–¢–µ–º:</strong> <span id="total-threads">0</span></p>
                        <p><strong>–°–æ–æ–±—â–µ–Ω–∏–π:</strong> <span id="total-posts">0</span></p>
                    </div>
                </div>

                <div class="sidebar-panel">
                    <div class="panel-header">üë• –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                    <div class="panel-body" id="online-users-list">
                        <p style="color: #999;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</p>
                    </div>
                </div>

                <div class="sidebar-panel">
                    <div class="panel-header">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                    <div class="panel-body">
                        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ—Ç—Ä–æ-—Ñ–æ—Ä—É–º –≤ —Å—Ç–∏–ª–µ 2007 –≥–æ–¥–∞!</p>
                        <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Å—É–∂–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å —Ç–µ–º—ã, –ø–∏—Å–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</p>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Forums View -->
                <div id="forums" class="view active">
                    <div class="forum-section">
                        <div class="section-header">üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ñ–æ—Ä—É–º–∞</div>
                        <div class="section-body" id="forums-list">
                            <div class="forum-item">
                                <div class="forum-icon">üìÅ</div>
                                <div class="forum-info">
                                    <h3 onclick="showForum(0)">–û—Å–Ω–æ–≤–Ω–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ</h3>
                                    <p>–¢–µ–º—ã –æ–±—â–µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –∏ –Ω–æ–≤–æ—Å—Ç–∏</p>
                                </div>
                                <div class="forum-stats">
                                    <strong id="forum-0-threads">0</strong><br><small>—Ç–µ–º</small>
                                </div>
                                <div class="forum-stats">
                                    <strong id="forum-0-posts">0</strong><br><small>–ø–æ—Å—Ç–æ–≤</small>
                                </div>
                            </div>
                            <div class="forum-item">
                                <div class="forum-icon">üíª</div>
                                <div class="forum-info">
                                    <h3 onclick="showForum(1)">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h3>
                                    <p>–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ü–ö –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞</p>
                                </div>
                                <div class="forum-stats">
                                    <strong id="forum-1-threads">0</strong><br><small>—Ç–µ–º</small>
                                </div>
                                <div class="forum-stats">
                                    <strong id="forum-1-posts">0</strong><br><small>–ø–æ—Å—Ç–æ–≤</small>
                                </div>
                            </div>
                            <div class="forum-item">
                                <div class="forum-icon">üéÆ</div>
                                <div class="forum-info">
                                    <h3 onclick="showForum(2)">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</h3>
                                    <p>–ò–≥—Ä—ã, –∫–∏–Ω–æ –∏ —Ö–æ–±–±–∏</p>
                                </div>
                                <div class="forum-stats">
                                    <strong id="forum-2-threads">0</strong><br><small>—Ç–µ–º</small>
                                </div>
                                <div class="forum-stats">
                                    <strong id="forum-2-posts">0</strong><br><small>–ø–æ—Å—Ç–æ–≤</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forum Threads View -->
                <div id="forum-view" class="view" style="display:none;">
                    <div class="action-bar">
                        <button class="button" onclick="backToForums()">‚Üê –ù–∞–∑–∞–¥</button>
                        <button class="button primary" onclick="openNewThreadModal()" id="create-thread-btn">üìù –ù–æ–≤–∞—è —Ç–µ–º–∞</button>
                        <input type="text" id="thread-search" class="input-field" placeholder="–ü–æ–∏—Å–∫ —Ç–µ–º..." style="flex:1; max-width:200px;">
                    </div>
                    <div class="forum-section">
                        <div class="section-header" id="forum-title">–¢–µ–º—ã —Ñ–æ—Ä—É–º–∞</div>
                        <div class="section-body" id="threads-list"></div>
                    </div>
                </div>

                <!-- Thread View -->
                <div id="thread-view" class="view" style="display:none;">
                    <div class="action-bar">
                        <button class="button" onclick="backToForum()">‚Üê –ö —Ñ–æ—Ä—É–º—É</button>
                    </div>
                    <div class="forum-section">
                        <div class="section-header" id="thread-title">–¢–µ–º–∞</div>
                        <div class="section-body" id="posts-list"></div>
                    </div>
                    <div class="action-bar">
                        <button class="button primary" onclick="openReplyModal()" id="reply-btn">üìù –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                        <button class="button" onclick="pinCurrentThread()" id="pin-btn" style="display:none;">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
                        <button class="button" onclick="lockCurrentThread()" id="lock-btn" style="display:none;">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>

                <!-- Messages View -->
                <div id="messages" class="view" style="display:none;">
                    <div class="user-status" id="message-status"></div>
                    <div class="action-bar">
                        <button class="button primary" onclick="openSendMessageModal()">‚úâÔ∏è –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                        <input type="text" id="message-search" class="input-field" placeholder="–ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π..." style="flex:1; max-width:200px;">
                    </div>
                    <div class="forum-section">
                        <div class="section-header">üíå –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                        <div class="section-body" id="messages-list"></div>
                    </div>
                </div>

                <!-- Profile View -->
                <div id="profile" class="view" style="display:none;">
                    <div class="user-status" id="profile-status"></div>
                    <div class="forum-section">
                        <div class="section-header">üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                        <div class="section-body" id="profile-content" style="padding: 12px;"></div>
                    </div>
                </div>

                <!-- Admin Panel View -->
                <div id="admin" class="view" style="display:none;">
                    <div class="forum-section">
                        <div class="section-header">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
                        <div class="section-body" style="padding: 12px;">
                            <div class="tabs">
                                <button class="tab-btn button active" onclick="switchAdminTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                                <button class="tab-btn button" onclick="switchAdminTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                                <button class="tab-btn button" onclick="switchAdminTab('logs')">üìã –õ–æ–≥–∏</button>
                            </div>

                            <!-- Users Management -->
                            <div id="users-tab" style="display:block;">
                                <h3 style="color: #000080; margin-bottom: 10px;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                                <input type="text" id="admin-user-search" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." style="margin-bottom: 10px;">
                                <div style="border: 1px solid #ddd; background: white; border-radius: 3px;">
                                    <div id="users-list" style="max-height: 400px; overflow-y: auto;"></div>
                                </div>
                            </div>

                            <!-- Forum Settings -->
                            <div id="settings-tab" style="display:none;">
                                <h3 style="color: #000080; margin-bottom: 10px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä—É–º–∞</h3>
                                <div style="background: white; padding: 10px; border-radius: 3px;">
                                    <p><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–æ—Ä—É–º–∞:</strong></p>
                                    <p>üìä –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="admin-total-users">0</span></p>
                                    <p>üìù –í—Å–µ–≥–æ —Ç–µ–º: <span id="admin-total-threads">0</span></p>
                                    <p>üí¨ –í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤: <span id="admin-total-posts">0</span></p>
                                    <p>‚úâÔ∏è –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: <span id="admin-total-messages">0</span></p>
                                    <hr style="border: none; border-top: 1px solid #ddd; margin: 10px 0;">
                                    <p style="font-size: 10px; color: #999; margin-bottom: 10px;">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞:</p>
                                    <button class="button danger" onclick="if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!')) clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –ë–î</button>
                                    <button class="button" onclick="exportData()" style="margin-left: 5px;">üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                                </div>
                            </div>

                            <!-- Logs -->
                            <div id="logs-tab" style="display:none;">
                                <h3 style="color: #000080; margin-bottom: 10px;">üìã –õ–æ–≥–∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
                                <div style="background: white; padding: 10px; border-radius: 3px; max-height: 400px; overflow-y: auto;" id="logs-list">
                                    <p style="color: #999; font-size: 11px;">–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–∞. –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ —Ñ–æ—Ä—É–º–µ.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login/Register Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="login-title">üîì –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                <div class="modal-close" onclick="closeModal('login-modal')">√ó</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <button class="button" style="margin-right: 10px;" onclick="switchLoginTab('login')">–í—Ö–æ–¥</button>
                    <button class="button" onclick="switchLoginTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>

                <!-- Login Tab -->
                <div id="login-tab">
                    <div class="form-group">
                        <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <input type="text" class="input-field" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" class="input-field" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å...">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="button primary" onclick="performLogin()">‚úì –í–æ–π—Ç–∏</button>
                        <button class="button" onclick="closeModal('login-modal')">‚úï –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>

                <!-- Register Tab -->
                <div id="register-tab" style="display:none;">
                    <div class="form-group">
                        <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                        <input type="text" class="input-field" id="register-username" placeholder="3-20 —Å–∏–º–≤–æ–ª–æ–≤...">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" class="input-field" id="register-email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" class="input-field" id="register-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤...">
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è:</label>
                        <input type="password" class="input-field" id="register-password2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å...">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="button primary" onclick="performRegister()">‚úì –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                        <button class="button" onclick="closeModal('login-modal')">‚úï –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Thread Modal -->
    <div id="new-thread-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–µ–º—É</span>
                <div class="modal-close" onclick="closeModal('new-thread-modal')">√ó</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>–§–æ—Ä—É–º:</label>
                    <select class="input-field" id="thread-forum">
                        <option value="0">–û—Å–Ω–æ–≤–Ω–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ</option>
                        <option value="1">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                        <option value="2">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º—ã:</label>
                    <input type="text" class="input-field" id="thread-title-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫..." maxlength="100">
                    <div class="char-counter"><span id="title-counter">0</span>/100</div>
                </div>
                <div class="form-group">
                    <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:</label>
                    <textarea class="textarea" id="thread-text-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." maxlength="5000"></textarea>
                    <div class="char-counter"><span id="content-counter">0</span>/5000</div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="thread-private"> üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è —Ç–µ–º–∞
                    </label>
                </div>
                <div id="private-users-select" style="display:none; margin-bottom: 10px; border: 1px solid #999; padding: 8px;">
                    <label style="display: block; margin-bottom: 5px;"><strong>–î–∞—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:</strong></label>
                    <div id="users-checkboxes" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="button primary" onclick="createNewThread()">‚úì –°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É</button>
                    <button class="button" onclick="closeModal('new-thread-modal')">‚úï –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="reply-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Ç–µ–º—É</span>
                <div class="modal-close" onclick="closeModal('reply-modal')">√ó</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <textarea class="textarea" id="reply-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." maxlength="5000"></textarea>
                    <div class="char-counter"><span id="reply-counter">0</span>/5000</div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="button" onclick="closeModal('reply-modal')">‚úï –û—Ç–º–µ–Ω–∞</button>
                    <button class="button primary" onclick="addReply()">‚úì –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Message Modal -->
    <div id="send-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>‚úâÔ∏è –ù–æ–≤–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                <div class="modal-close" onclick="closeModal('send-message-modal')">√ó</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>–ö–æ–º—É:</label>
                    <select class="input-field" id="message-recipient">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–¢–µ–º–∞:</label>
                    <input type="text" class="input-field" id="message-subject" placeholder="–¢–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏—è..." maxlength="100">
                </div>
                <div class="form-group">
                    <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <textarea class="textarea" id="message-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..." maxlength="5000"></textarea>
                    <div class="char-counter"><span id="message-counter">0</span>/5000</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="button primary" onclick="sendPrivateMessage()">‚úì –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button class="button" onclick="closeModal('send-message-modal')">‚úï –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ DATA STRUCTURE ============
        const forumData = {
            users: [],
            forums: [
                { id: 0, name: '–û—Å–Ω–æ–≤–Ω–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ', desc: '–¢–µ–º—ã –æ–±—â–µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –∏ –Ω–æ–≤–æ—Å—Ç–∏', threads: [] },
                { id: 1, name: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', desc: '–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ü–ö –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞', threads: [] },
                { id: 2, name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', desc: '–ò–≥—Ä—ã, –∫–∏–Ω–æ –∏ —Ö–æ–±–±–∏', threads: [] }
            ],
            messages: [],
            logs: []
        };

        let currentUser = null;
        let currentForum = null;
        let currentThread = null;
        let onlineUsers = [];

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            currentUser = getCurrentUser();
            updateHeader();
            updateStatistics();
            updateOnlineUsers();
            setupCharCounters();
            setupSearchBoxes();
            setInterval(updateOnlineUsers, 5000);
        });

        // ============ CHARACTER COUNTER SETUP ============
        function setupCharCounters() {
            const counters = {
                'thread-title-input': 'title-counter',
                'thread-text-input': 'content-counter',
                'reply-text': 'reply-counter',
                'message-text': 'message-counter'
            };

            Object.entries(counters).forEach(([input, counter]) => {
                const elem = document.getElementById(input);
                if (elem) {
                    elem.addEventListener('input', function() {
                        document.getElementById(counter).textContent = this.value.length;
                    });
                }
            });
        }

        // ============ SEARCH SETUP ============
        function setupSearchBoxes() {
            const threadSearch = document.getElementById('thread-search');
            if (threadSearch) {
                threadSearch.addEventListener('input', function() {
                    searchThreads(this.value);
                });
            }

            const messageSearch = document.getElementById('message-search');
            if (messageSearch) {
                messageSearch.addEventListener('input', function() {
                    searchMessages(this.value);
                });
            }

            const adminUserSearch = document.getElementById('admin-user-search');
            if (adminUserSearch) {
                adminUserSearch.addEventListener('input', function() {
                    searchUsers(this.value);
                });
            }
        }

        // ============ STORAGE MANAGEMENT ============
        function saveData() {
            localStorage.setItem('forumData', JSON.stringify(forumData));
        }

        function loadData() {
            const data = localStorage.getItem('forumData');
            if (data) {
                try {
                    const loaded = JSON.parse(data);
                    forumData.users = loaded.users || [];
                    forumData.forums = loaded.forums || forumData.forums;
                    forumData.messages = loaded.messages || [];
                    forumData.logs = loaded.logs || [];
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }

        function getCurrentUser() {
            const user = localStorage.getItem('currentUser');
            return user ? JSON.parse(user) : null;
        }

        function setCurrentUser(user) {
            currentUser = user;
            if (user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                onlineUsers = onlineUsers.filter(u => u.id !== user.id);
                onlineUsers.push({...user, lastActivity: new Date().getTime()});
            } else {
                localStorage.removeItem('currentUser');
            }
            updateHeader();
            updateStatistics();
        }

        function addLog(action, details = '') {
            forumData.logs.push({
                timestamp: new Date().toLocaleString('ru-RU'),
                user: currentUser ? currentUser.username : '–ì–æ—Å—Ç—å',
                action: action,
                details: details
            });
            if (forumData.logs.length > 100) {
                forumData.logs = forumData.logs.slice(-100);
            }
            saveData();
        }

        // ============ UI UPDATE FUNCTIONS ============
        function updateHeader() {
            const status = document.getElementById('header-status');
            const adminBtn = document.getElementById('admin-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (currentUser) {
                status.innerHTML = `
                    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong style="color: #ffff00;">${currentUser.username}</strong></p>
                    <p>${currentUser.isAdmin ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : (currentUser.isModerator ? 'üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–£—á–∞—Å—Ç–Ω–∏–∫')}</p>
                `;
                adminBtn.style.display = currentUser.isAdmin ? 'block' : 'none';
                logoutBtn.style.display = 'block';
            } else {
                status.innerHTML = '<p>–í—ã –Ω–µ –≤–æ—à–ª–∏</p>';
                adminBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        }

        function updateStatistics() {
            let totalThreads = 0;
            let totalPosts = 0;

            forumData.forums.forEach(forum => {
                totalThreads += forum.threads.length;
                forum.threads.forEach(thread => {
                    totalPosts += thread.posts.length;
                });
            });

            document.getElementById('total-users').textContent = forumData.users.length;
            document.getElementById('online-users').textContent = onlineUsers.length;
            document.getElementById('total-threads').textContent = totalThreads;
            document.getElementById('total-posts').textContent = totalPosts;

            document.getElementById('admin-total-users').textContent = forumData.users.length;
            document.getElementById('admin-total-threads').textContent = totalThreads;
            document.getElementById('admin-total-posts').textContent = totalPosts;
            document.getElementById('admin-total-messages').textContent = forumData.messages.length;

            forumData.forums.forEach((forum, idx) => {
                let forumPosts = 0;
                forum.threads.forEach(thread => {
                    forumPosts += thread.posts.length;
                });
                document.getElementById(`forum-${idx}-threads`).textContent = forum.threads.length;
                document.getElementById(`forum-${idx}-posts`).textContent = forumPosts;
            });

            updateMessageBadge();
        }

        function updateMessageBadge() {
            if (!currentUser) return;
            const unreadCount = forumData.messages.filter(msg => msg.to === currentUser.id && !msg.read).length;
            const badge = document.getElementById('message-badge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
            } else {
                badge.textContent = '';
            }
        }

        function updateOnlineUsers() {
            const container = document.getElementById('online-users-list');
            const now = new Date().getTime();
            onlineUsers = onlineUsers.filter(u => (now - u.lastActivity) < 300000);

            if (currentUser) {
                const user = onlineUsers.find(u => u.id === currentUser.id);
                if (user) {
                    user.lastActivity = now;
                } else {
                    onlineUsers.push({...currentUser, lastActivity: now});
                }
            }

            if (onlineUsers.length === 0) {
                container.innerHTML = '<p style="color: #999;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</p>';
            } else {
                let html = '';
                onlineUsers.forEach(user => {
                    html += `
                        <div style="padding: 4px 0; font-size: 10px;">
                            <span class="online-status"></span>${user.username} 
                            <span style="color: #999;">‚≠ê${user.reputation || 0}</span>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        }

        // ============ AUTH FUNCTIONS ============
        function openLoginModal() {
            document.getElementById('login-modal').classList.add('active');
            switchLoginTab('login');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        }

        function showLoginModal() {
            openLoginModal();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function switchLoginTab(tab) {
            document.getElementById('login-tab').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('register-tab').style.display = tab === 'register' ? 'block' : 'none';
        }

        function performLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const user = forumData.users.find(u => u.username === username && u.password === password);
            if (!user) {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å!');
                return;
            }

            if (user.isBanned) {
                alert('‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!');
                return;
            }

            const greeting = user.isAdmin ? `‚úì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ${username}!` : 
                            user.isModerator ? `‚úì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä ${username}!` :
                            `‚úì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`;
            alert(greeting);

            setCurrentUser(user);
            closeModal('login-modal');
            showView('forums');
            addLog('–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username}`);
        }

        function performRegister() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const password2 = document.getElementById('register-password2').value;

            if (!username || !email || !password || !password2) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            if (username.length < 3 || username.length > 20) {
                alert('‚ùå –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }

            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                alert('‚ùå –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–∏—Å!');
                return;
            }

            if (password.length < 6) {
                alert('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }

            if (password !== password2) {
                alert('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
                return;
            }

            if (forumData.users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
                alert('‚ùå –≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
                return;
            }

            if (forumData.users.find(u => u.email === email)) {
                alert('‚ùå –≠—Ç–æ—Ç Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!');
                return;
            }

            const isAdmin = forumData.users.length === 0;

            const newUser = {
                id: Date.now(),
                username: username,
                email: email,
                password: password,
                avatar: username[0].toUpperCase(),
                joinDate: new Date().toLocaleDateString('ru-RU'),
                isAdmin: isAdmin,
                isModerator: false,
                isBanned: false,
                canCreateThreads: true,
                canPostReplies: true,
                canSendMessages: true,
                threads: [],
                posts: [],
                reputation: 0,
                lastActivity: new Date().getTime()
            };

            forumData.users.push(newUser);
            saveData();

            if (isAdmin) {
                alert(`‚úì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ñ–æ—Ä—É–º–∞.`);
            } else {
                alert(`‚úì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º–∏ —É—á—ë—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.`);
            }

            document.getElementById('register-username').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-password2').value = '';

            switchLoginTab('login');
            addLog('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', `–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}`);
        }

        function logout() {
            if (currentUser) {
                addLog('–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', currentUser.username);
            }
            setCurrentUser(null);
            currentForum = null;
            currentThread = null;
            onlineUsers = [];
            showView('forums');
            alert('‚úì –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }

        // ============ FORUM FUNCTIONS ============
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view).classList.add('active');

            if ((view === 'messages' || view === 'profile' || view === 'admin') && !currentUser) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
                openLoginModal();
                showView('forums');
                return;
            }

            if (view === 'admin' && !currentUser.isAdmin) {
                alert('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
                showView('forums');
                return;
            }

            if (view === 'messages') {
                updateMessages();
                updateMessageBadge();
            } else if (view === 'profile') {
                updateProfile();
            } else if (view === 'admin') {
                updateAdminPanel();
            }
        }

        function showForum(forumId) {
            if (!currentUser) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
                openLoginModal();
                return;
            }

            currentForum = forumId;
            const forum = forumData.forums[forumId];
            document.getElementById('forum-title').textContent = 'üìÅ ' + forum.name;

            renderThreadsList(forumId);

            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('forum-view').classList.add('active');
        }

        function renderThreadsList(forumId) {
            const threadsList = document.getElementById('threads-list');
            const forum = forumData.forums[forumId];
            threadsList.innerHTML = '';

            const availableThreads = forum.threads.filter(thread => {
                if (thread.isPrivate) {
                    return thread.allowedUsers && thread.allowedUsers.includes(currentUser.id);
                }
                return true;
            });

            const pinnedThreads = availableThreads.filter(t => t.isPinned).sort((a, b) => b.views - a.views);
            const regularThreads = availableThreads.filter(t => !t.isPinned).sort((a, b) => b.views - a.views);
            const sortedThreads = [...pinnedThreads, ...regularThreads];

            if (availableThreads.length === 0) {
                threadsList.innerHTML = '<div class="no-data">–í —ç—Ç–æ–º —Ñ–æ—Ä—É–º–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–µ–º. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º–∏! üìù</div>';
            } else {
                sortedThreads.forEach((thread) => {
                    const originalIdx = forum.threads.indexOf(thread);
                    const postsCount = thread.posts.length;
                    const lockBadge = thread.isPrivate ? '<span class="lock-badge">üîí –ü–†–ò–í–ê–¢–ù–ê–Ø</span>' : '';
                    const pinBadge = thread.isPinned ? '<span class="lock-badge" style="background: #ccffcc; color: #00aa00;">üìå –ó–ê–ö–†–ï–ü–õ–ï–ù–ê</span>' : '';
                    const lockThreadBadge = thread.isLocked ? '<span class="lock-badge" style="background: #ffcccc; color: #cc0000;">üîí –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê</span>' : '';
                    const threadIcon = thread.isLocked ? 'üîí' : (postsCount > 5 ? 'üî•' : 'üí¨');
                    
                    threadsList.innerHTML += `
                        <div class="thread-item">
                            <div class="thread-icon">${threadIcon}</div>
                            <div class="thread-info">
                                <h4 onclick="showThread(${forumId}, ${originalIdx})" style="${thread.isPinned ? 'font-weight: bold; color: #ff6600;' : ''}">${escapeHtml(thread.title)}</h4>
                                <p>üë§ ${escapeHtml(thread.author)} | üìÖ ${thread.date} | üëÅÔ∏è ${thread.views || 0} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ${lockBadge}${pinBadge}${lockThreadBadge}</p>
                            </div>
                            <div class="forum-stats">
                                <strong>${postsCount}</strong><br><small>–æ—Ç–≤–µ—Ç.</small>
                            </div>
                            <button class="button" onclick="showThread(${forumId}, ${originalIdx})">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button>
                        </div>
                    `;
                });
            }
        }

        function searchThreads(query) {
            if (currentForum === null) return;
            const threadsList = document.getElementById('threads-list');
            const forum = forumData.forums[currentForum];
            threadsList.innerHTML = '';

            const availableThreads = forum.threads.filter(thread => {
                if (thread.isPrivate) {
                    return thread.allowedUsers && thread.allowedUsers.includes(currentUser.id);
                }
                return true;
            });

            const filtered = availableThreads.filter(t => 
                t.title.toLowerCase().includes(query.toLowerCase()) ||
                t.author.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length === 0) {
                threadsList.innerHTML = '<div class="no-data">–¢–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üîç</div>';
                return;
            }

            filtered.forEach((thread) => {
                const originalIdx = forum.threads.indexOf(thread);
                const postsCount = thread.posts.length;
                threadsList.innerHTML += `
                    <div class="thread-item">
                        <div class="thread-icon">üí¨</div>
                        <div class="thread-info">
                            <h4 onclick="showThread(${currentForum}, ${originalIdx})">${escapeHtml(thread.title)}</h4>
                            <p>üë§ ${escapeHtml(thread.author)} | üìÖ ${thread.date}</p>
                        </div>
                        <div class="forum-stats">
                            <strong>${postsCount}</strong><br><small>–æ—Ç–≤–µ—Ç.</small>
                        </div>
                        <button class="button" onclick="showThread(${currentForum}, ${originalIdx})">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</button>
                    </div>
                `;
            });
        }

        function backToForums() {
            showView('forums');
            currentForum = null;
            document.getElementById('thread-search').value = '';
        }

        function backToForum() {
            if (currentForum !== null) {
                showForum(currentForum);
                document.getElementById('thread-search').value = '';
            }
        }

        function showThread(forumId, threadId) {
            currentForum = forumId;
            currentThread = threadId;
            const thread = forumData.forums[forumId].threads[threadId];

            if (!currentUser && thread.isPrivate) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
                openLoginModal();
                return;
            }

            if (thread.isPrivate && (!thread.allowedUsers || !thread.allowedUsers.includes(currentUser.id))) {
                alert('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ç–µ–º–µ!');
                return;
            }

            thread.views = (thread.views || 0) + 1;
            saveData();

            const lockIcon = thread.isLocked ? 'üîí' : 'üí¨';
            const pinIcon = thread.isPinned ? 'üìå' : 'üí¨';
            document.getElementById('thread-title').textContent = `${pinIcon} ${escapeHtml(thread.title)}`;

            const postsList = document.getElementById('posts-list');
            postsList.innerHTML = '';

            thread.posts.forEach((post, idx) => {
                const posterUser = forumData.users.find(u => u.id === post.userId);
                const posterName = posterUser ? posterUser.username : '–£–¥–∞–ª—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const posterAvatar = posterUser ? posterUser.avatar : '?';
                const reputation = posterUser ? (posterUser.reputation || 0) : 0;
                const likesCount = post.likes || 0;
                const isAuthor = currentUser && currentUser.id === post.userId;
                const isAdmin = currentUser && currentUser.isAdmin;

                let postActions = `üëç <span id="likes-${idx}">${likesCount}</span>`;
                if (!thread.isLocked) {
                    postActions += ` | <span class="post-action-link" onclick="likePost(${forumId}, ${threadId}, ${idx})">üëç –ù—Ä–∞–≤–∏—Ç—Å—è</span>`;
                    postActions += ` | <span class="post-action-link" onclick="openReplyToPostModal(${idx})">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</span>`;
                }
                if (isAuthor || isAdmin) {
                    postActions += ` | <span class="post-action-link" onclick="deletePost(${forumId}, ${threadId}, ${idx})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</span>`;
                }
                if (isAdmin && !isAuthor) {
                    postActions += ` | <span class="post-action-link" onclick="warnUser('${posterName}')">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å</span>`;
                }

                postsList.innerHTML += `
                    <div class="post-item">
                        <div class="post-header">
                            ${thread.isLocked ? 'üîí –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê' : 'üìå'} ${escapeHtml(posterName)} (‚≠ê ${reputation})
                            <span>${post.date} ${post.time || ''}</span>
                        </div>
                        <div class="post-body">
                            <div class="post-avatar">${posterAvatar}</div>
                            <div class="post-content">${escapeHtml(post.text)}</div>
                        </div>
                        <div class="post-footer">
                            ${postActions}
                        </div>
                    </div>
                `;
            });

            document.getElementById('reply-btn').style.display = thread.isLocked ? 'none' : 'block';
            document.getElementById('pin-btn').style.display = currentUser && currentUser.isAdmin ? 'block' : 'none';
            document.getElementById('lock-btn').style.display = currentUser && currentUser.isAdmin ? 'block' : 'none';

            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('thread-view').classList.add('active');
            addLog('–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–º—ã', thread.title);
        }

        function pinCurrentThread() {
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∑–∞–∫—Ä–µ–ø–ª—è—Ç—å —Ç–µ–º—ã!');
                return;
            }
            const thread = forumData.forums[currentForum].threads[currentThread];
            thread.isPinned = !thread.isPinned;
            saveData();
            showThread(currentForum, currentThread);
            alert(thread.isPinned ? 'üìå –¢–µ–º–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞!' : 'üìå –ö—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–Ω—è—Ç–æ!');
            addLog('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ–º—ã', `${thread.isPinned ? '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∞' : '–û—Ç–∫—Ä–µ–ø–ª–µ–Ω–∞'}: ${thread.title}`);
        }

        function lockCurrentThread() {
            if (!currentUser || !currentUser.isAdmin) {
                alert('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—ã!');
                return;
            }
            const thread = forumData.forums[currentForum].threads[currentThread];
            thread.isLocked = !thread.isLocked;
            saveData();
            showThread(currentForum, currentThread);
            alert(thread.isLocked ? 'üîí –¢–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!' : 'üîì –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞!');
            addLog('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–µ–º—ã', `${thread.isLocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞'}: ${thread.title}`);
        }

        function deletePost(forumId, threadId, postIndex) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ!')) return;

            const post = forumData.forums[forumId].threads[threadId].posts[postIndex];
            forumData.forums[forumId].threads[threadId].posts.splice(postIndex, 1);
            saveData();
            showThread(forumId, threadId);
            alert('‚úì –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!');
            addLog('–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è', '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
        }

        function warnUser(username) {
            const user = forumData.users.find(u => u.username === username);
            if (!user) return;
            user.warnings = (user.warnings || 0) + 1;
            if (user.warnings >= 3) {
                user.isBanned = true;
                alert(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} –ø–æ–ª—É—á–∏–ª –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (3/3). –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
                addLog('–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', `${username} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è`);
            } else {
                alert(`‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${username}! (${user.warnings}/3)`);
                addLog('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é', `${username} –ø–æ–ª—É—á–∏–ª –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (${user.warnings}/3)`);
            }
            saveData();
        }

        function openNewThreadModal() {
            if (!currentUser) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
                openLoginModal();
                return;
            }
            if (!currentUser.canCreateThreads) {
                alert('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ–º—ã!');
                return;
            }
            updateUsersCheckboxes();
            document.getElementById('new-thread-modal').classList.add('active');
            document.getElementById('thread-title-input').value = '';
            document.getElementById('thread-text-input').value = '';
            document.getElementById('thread-private').checked = false;
            document.getElementById('private-users-select').style.display = 'none';
            document.getElementById('title-counter').textContent = '0';
            document.getElementById('content-counter').textContent = '0';
        }

        function updateUsersCheckboxes() {
            const container = document.getElementById('users-checkboxes');
            container.innerHTML = '';
            forumData.users.forEach(user => {
                if (user.id !== currentUser.id && !user.isBanned) {
                    container.innerHTML += `
                        <label style="display: block; margin: 3px 0; font-size: 10px;">
                            <input type="checkbox" value="${user.id}" class="user-checkbox"> ${escapeHtml(user.username)}
                        </label>
                    `;
                }
            });
        }

        const threadPrivateCheckbox = document.getElementById('thread-private');
        if (threadPrivateCheckbox) {
            threadPrivateCheckbox.addEventListener('change', function() {
                document.getElementById('private-users-select').style.display = this.checked ? 'block' : 'none';
            });
        }

        function createNewThread() {
            if (!currentUser) return;

            const title = document.getElementById('thread-title-input').value.trim();
            const text = document.getElementById('thread-text-input').value.trim();
            const forumId = parseInt(document.getElementById('thread-forum').value);
            const isPrivate = document.getElementById('thread-private').checked;

            if (!title || !text) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            if (title.length < 5) {
                alert('‚ùå –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }

            let allowedUsers = [currentUser.id];
            if (isPrivate) {
                const checkboxes = document.querySelectorAll('.user-checkbox:checked');
                if (checkboxes.length === 0) {
                    alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–π —Ç–µ–º—ã!');
                    return;
                }
                checkboxes.forEach(cb => {
                    allowedUsers.push(parseInt(cb.value));
                });
            }

            const newThread = {
                id: Date.now(),
                title: title,
                author: currentUser.username,
                authorId: currentUser.id,
                date: new Date().toLocaleDateString('ru-RU'),
                time: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
                isPrivate: isPrivate,
                allowedUsers: allowedUsers,
                isPinned: false,
                isLocked: false,
                posts: [{
                    userId: currentUser.id,
                    text: text,
                    date: new Date().toLocaleDateString('ru-RU'),
                    time: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
                    likes: 0
                }],
                views: 0,
                reputation: 0,
                tags: []
            };

            forumData.forums[forumId].threads.push(newThread);
            currentUser.threads.push(newThread.id);
            saveData();
            updateStatistics();

            closeModal('new-thread-modal');
            alert('‚úì –¢–µ–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
            showForum(forumId);
            addLog('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–µ–º—ã', title);
        }

        function likePost(forumId, threadId, postIndex) {
            if (!currentUser) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
                openLoginModal();
                return;
            }
            const post = forumData.forums[forumId].threads[threadId].posts[postIndex];
            post.likes = (post.likes || 0) + 1;
            
            const posterUser = forumData.users.find(u => u.id === post.userId);
            if (posterUser) {
                posterUser.reputation = (posterUser.reputation || 0) + 1;
            }
            
            saveData();
            showThread(forumId, threadId);
        }

        function openReplyModal() {
            if (!currentUser) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
                openLoginModal();
                return;
            }
            if (!currentUser.canPostReplies) {
                alert('‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ç–µ–º—ã!');
                return;
            }
            if (currentForum === null || currentThread === null) {
                alert('‚ùå –û—à–∏–±–∫–∞: —Ç–µ–º–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞');
                return;
            }
            const thread = forumData.forums[currentForum].threads[currentThread];
            if (thread.isLocked) {
                alert('üîí –≠—Ç–∞ —Ç–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ!');
                return;
            }
            document.getElementById('reply-text').value = '';
            document.getElementById('reply-counter').textContent = '0';
            document.getElementById('reply-modal').classList.add('active');
        }

        function openReplyToPostModal(postIndex) {
            openReplyModal();
        }

        function addReply() {
            if (!currentUser || currentForum === null || currentThread === null) return;

            const text = document.getElementById('reply-text').value.trim();
            if (!text) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!');
                return;
            }

            const thread = forumData.forums[currentForum].threads[currentThread];
            const now = new Date();
            thread.posts.push({
                id: Date.now(),
                userId: currentUser.id,
                text: text,
                date: now.toLocaleDateString('ru-RU'),
                time: now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
                likes: 0
            });

            currentUser.posts.push(thread.id);
            saveData();
            closeModal('reply-modal');
            showThread(currentForum, currentThread);
            alert('‚úì –û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
            updateStatistics();
            addLog('–û—Ç–≤–µ—Ç –Ω–∞ —Ç–µ–º—É', thread.title);
        }

        // ============ MESSAGES FUNCTIONS ============
        function openSendMessageModal() {
            if (!currentUser) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
                openLoginModal();
                return;
            }

            const select = document.getElementById('message-recipient');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</option>';
            forumData.users.forEach(user => {
                if (user.id !== currentUser.id && !user.isBanned) {
                    select.innerHTML += `<option value="${user.id}">${escapeHtml(user.username)}</option>`;
                }
            });

            document.getElementById('message-subject').value = '';
            document.getElementById('message-text').value = '';
            document.getElementById('message-counter').textContent = '0';
            document.getElementById('send-message-modal').classList.add('active');
        }

        function sendPrivateMessage() {
            if (!currentUser) return;

            const recipientId = parseInt(document.getElementById('message-recipient').value);
            const subject = document.getElementById('message-subject').value.trim();
            const text = document.getElementById('message-text').value.trim();

            if (!recipientId || !subject || !text) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const recipient = forumData.users.find(u => u.id === recipientId);
            if (!recipient) {
                alert('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }

            if (recipient.isBanned) {
                alert('‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
                return;
            }

            forumData.messages.push({
                id: Date.now(),
                from: currentUser.id,
                fromName: currentUser.username,
                to: recipientId,
                subject: subject,
                text: text,
                date: new Date().toLocaleDateString('ru-RU'),
                time: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
                read: false
            });

            saveData();
            closeModal('send-message-modal');
            alert('‚úì –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            updateStatistics();
            addLog('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è', `–û—Ç: ${currentUser.username}, –ö–æ–º—É: ${recipient.username}`);
        }

        function updateMessages() {
            if (!currentUser) return;

            const messageStatus = document.getElementById('message-status');
            const userMessages = forumData.messages.filter(msg => msg.to === currentUser.id);
            const unreadCount = userMessages.filter(msg => !msg.read).length;

            messageStatus.innerHTML = `
                <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong> –í—Å–µ–≥–æ: ${userMessages.length} | –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö: <span style="color: #ff0000;">${unreadCount}</span>
            `;

            renderMessagesList(userMessages);
        }

        function renderMessagesList(messages) {
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';

            if (messages.length === 0) {
                messagesList.innerHTML = '<div class="no-data">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π üì≠</div>';
                return;
            }

            const sorted = messages.sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach((msg, idx) => {
                const fromUser = forumData.users.find(u => u.id === msg.from);
                const unreadClass = msg.read ? '' : 'message-unread';
                messagesList.innerHTML += `
                    <div class="message-item ${unreadClass}">
                        <div class="message-from">–û—Ç: ${escapeHtml(msg.fromName)} (${msg.read ? '‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ' : '‚äô –ù–æ–≤–æ–µ'})</div>
                        <div class="message-subject">üìå ${escapeHtml(msg.subject)}</div>
                        <div class="message-text">${escapeHtml(msg.text)}</div>
                        <div class="message-time">
                            ${msg.date} ${msg.time} | 
                            <span class="post-action-link" onclick="markMessageAsRead(${msg.id})">‚úì –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ</span> |
                            <span class="post-action-link" onclick="deleteMessage(${msg.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</span> |
                            <span class="post-action-link" onclick="replyToMessage('${escapeHtml(msg.fromName)}')">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</span>
                        </div>
                    </div>
                `;
            });
        }

        function searchMessages(query) {
            if (!currentUser) return;
            const userMessages = forumData.messages.filter(msg => msg.to === currentUser.id);
            const filtered = userMessages.filter(msg =>
                msg.fromName.toLowerCase().includes(query.toLowerCase()) ||
                msg.subject.toLowerCase().includes(query.toLowerCase()) ||
                msg.text.toLowerCase().includes(query.toLowerCase())
            );
            renderMessagesList(filtered);
        }

        function markMessageAsRead(msgId) {
            const msg = forumData.messages.find(m => m.id === msgId);
            if (msg) {
                msg.read = true;
                saveData();
                updateMessages();
                updateMessageBadge();
            }
        }

        function deleteMessage(msgId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            forumData.messages = forumData.messages.filter(m => m.id !== msgId);
            saveData();
            updateMessages();
            updateStatistics();
            alert('‚úì –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!');
        }

        function replyToMessage(username) {
            if (forumData.users.find(u => u.username === username)) {
                const select = document.getElementById('message-recipient');
                select.value = forumData.users.find(u => u.username === username).id;
            }
            document.getElementById('message-subject').value = `Re: `;
            document.getElementById('send-message-modal').classList.add('active');
        }

        // ============ PROFILE FUNCTIONS ============
        function updateProfile() {
            if (!currentUser) return;

            const profileStatus = document.getElementById('profile-status');
            profileStatus.innerHTML = `
                <strong>üë§ ${escapeHtml(currentUser.username)}</strong> | 
                ‚≠ê –†–µ–ø—É—Ç–∞—Ü–∏—è: ${currentUser.reputation || 0} |
                üìù –¢–µ–º: ${currentUser.threads.length} |
                üí¨ –ü–æ—Å—Ç–æ–≤: ${currentUser.posts.length}
            `;

            const profileContent = document.getElementById('profile-content');
            profileContent.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 3px;">
                    <p><strong>üìß Email:</strong> ${escapeHtml(currentUser.email)}</p>
                    <p><strong>üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${currentUser.joinDate}</p>
                    <p><strong>üìä –°—Ç–∞—Ç—É—Å:</strong> ${currentUser.isAdmin ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : (currentUser.isModerator ? 'üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–£—á–∞—Å—Ç–Ω–∏–∫')}</p>
                    <p><strong>‚≠ê –†–µ–ø—É—Ç–∞—Ü–∏—è:</strong> ${currentUser.reputation || 0}</p>
                    <p><strong>üìù –°–æ–∑–¥–∞–Ω–æ —Ç–µ–º:</strong> ${currentUser.threads.length}</p>
                    <p><strong>üí¨ –ù–∞–ø–∏—Å–∞–Ω–æ –ø–æ—Å—Ç–æ–≤:</strong> ${currentUser.posts.length}</p>
                    <p><strong>üõë –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:</strong> ${currentUser.warnings || 0}/3</p>
                    <hr style="border: none; border-top: 1px solid #ddd; margin: 15px 0;">
                    <p style="font-size: 10px; color: #999;">Avatar: <strong>${currentUser.avatar}</strong></p>
                </div>
            `;
        }

        // ============ ADMIN FUNCTIONS ============
        function switchAdminTab(tab) {
            document.getElementById('users-tab').style.display = tab === 'users' ? 'block' : 'none';
            document.getElementById('settings-tab').style.display = tab === 'settings' ? 'block' : 'none';
            document.getElementById('logs-tab').style.display = tab === 'logs' ? 'block' : 'none';

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateAdminPanel() {
            updateAdminUsersList();
            updateAdminLogs();
            updateStatistics();
        }

        function updateAdminUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            if (forumData.users.length === 0) {
                usersList.innerHTML = '<div class="no-data">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }

            forumData.users.forEach(user => {
                const statusBadge = user.isAdmin ? 'üëë' : (user.isModerator ? 'üõ°Ô∏è' : 'üë§');
                const banBadge = user.isBanned ? 'üö´' : '';
                usersList.innerHTML += `
                    <div class="user-item">
                        <div>
                            ${statusBadge} ${escapeHtml(user.username)} ${banBadge}
                            <span style="color: #999; font-size: 9px;">‚≠ê${user.reputation || 0}</span>
                        </div>
                        <div class="user-item-actions">
                            ${!user.isAdmin ? `<button class="button" style="padding: 2px 6px; font-size: 10px;" onclick="promoteUser(${user.id})">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</button>` : ''}
                            <button class="button ${user.isBanned ? 'danger' : ''}" style="padding: 2px 6px; font-size: 10px;" onclick="banUser(${user.id})">${user.isBanned ? '–†–∞–∑–±–∞–Ω–∏—Ç—å' : '–ë–∞–Ω'}</button>
                        </div>
                    </div>
                `;
            });
        }

        function promoteUser(userId) {
            const user = forumData.users.find(u => u.id === userId);
            if (!user) return;
            user.isModerator = !user.isModerator;
            saveData();
            updateAdminUsersList();
            alert(user.isModerator ? `‚úì ${user.username} –Ω–∞–∑–Ω–∞—á–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º!` : `${user.username} —Å–Ω—è—Ç —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞!`);
            addLog('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', `${user.username}: ${user.isModerator ? '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä' : '–£—á–∞—Å—Ç–Ω–∏–∫'}`);
        }

        function banUser(userId) {
            const user = forumData.users.find(u => u.id === userId);
            if (!user) return;
            if (user.isAdmin) {
                alert('‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
                return;
            }
            user.isBanned = !user.isBanned;
            saveData();
            updateAdminUsersList();
            alert(user.isBanned ? `‚úì ${user.username} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!` : `‚úì ${user.username} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
            addLog('–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', `${user.username}: ${user.isBanned ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`);
        }

        function searchUsers(query) {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            const filtered = forumData.users.filter(u => 
                u.username.toLowerCase().includes(query.toLowerCase()) ||
                u.email.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length === 0) {
                usersList.innerHTML = '<div class="no-data">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            filtered.forEach(user => {
                const statusBadge = user.isAdmin ? 'üëë' : (user.isModerator ? 'üõ°Ô∏è' : 'üë§');
                const banBadge = user.isBanned ? 'üö´' : '';
                usersList.innerHTML += `
                    <div class="user-item">
                        <div>
                            ${statusBadge} ${escapeHtml(user.username)} ${banBadge}
                        </div>
                        <div class="user-item-actions">
                            ${!user.isAdmin ? `<button class="button" style="padding: 2px 6px; font-size: 10px;" onclick="promoteUser(${user.id})">–ú–æ–¥</button>` : ''}
                            <button class="button ${user.isBanned ? 'danger' : ''}" style="padding: 2px 6px; font-size: 10px;" onclick="banUser(${user.id})">${user.isBanned ? '–†–∞–∑–±–∞–Ω' : '–ë–∞–Ω'}</button>
                        </div>
                    </div>
                `;
            });
        }

        function updateAdminLogs() {
            const logsList = document.getElementById('logs-list');
            logsList.innerHTML = '';

            if (forumData.logs.length === 0) {
                logsList.innerHTML = '<p style="color: #999; font-size: 11px;">–õ–æ–≥–∏ –ø—É—Å—Ç—ã</p>';
                return;
            }

            const recentLogs = forumData.logs.slice(-20).reverse();
            recentLogs.forEach(log => {
                logsList.innerHTML += `
                    <div style="padding: 6px; border-bottom: 1px solid #eee; font-size: 10px;">
                        <strong>${log.timestamp}</strong> - ${escapeHtml(log.user)}: ${escapeHtml(log.action)}
                        ${log.details ? `<br><em>${escapeHtml(log.details)}</em>` : ''}
                    </div>
                `;
            });
        }

        function clearAllData() {
            forumData.users = [];
            forumData.forums = [
                { id: 0, name: '–û—Å–Ω–æ–≤–Ω–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ', desc: '–¢–µ–º—ã –æ–±—â–µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –∏ –Ω–æ–≤–æ—Å—Ç–∏', threads: [] },
                { id: 1, name: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', desc: '–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ü–ö –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞', threads: [] },
                { id: 2, name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', desc: '–ò–≥—Ä—ã, –∫–∏–Ω–æ –∏ —Ö–æ–±–±–∏', threads: [] }
            ];
            forumData.messages = [];
            forumData.logs = [];
            saveData();
            currentUser = null;
            localStorage.removeItem('currentUser');
            alert('üóëÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞!');
            location.reload();
        }

        function exportData() {
            const dataStr = JSON.stringify(forumData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `forum-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('‚úì –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            addLog('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö', '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞');
        }

        // ============ UTILITY FUNCTIONS ============
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
